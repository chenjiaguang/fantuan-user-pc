(function(){function p(a){function b(){var b=a.getSelection();b&&(b.getType()!==CKEDITOR.SELECTION_NONE&&b.getStartElement().is("img")?c.event&&c.event.button&&0!==c.event.button||d.show(b.getStartElement().$):d.hide())}var c=a.window.$,e=a.document.$,d=new l(a,{snapToSize:7});e.addEventListener("mousedown",function(a){d.isHandle(a.target)&&d.initDrag(a)},!1);a.on("selectionChange",b);a.on("getData",function(a){var b=a.data.dataValue||"",b=b.replace(/<div id="ckimgrsz"([\s\S]*?)<\/div>/i,""),b=b.replace(/\b(ckimgrsz)\b/g,
"");a.data.dataValue=b});a.on("beforeUndoImage",function(){d.hide()});a.on("afterUndoImage",function(){b()});a.on("blur",function(){d.hide()});a.on("beforeModeUnload",function q(){a.removeListener("beforeModeUnload",q);d.hide()});var f;a.window.on("resize",function(){clearTimeout(f);f=setTimeout(b,50)})}function l(a,b){this.editor=a;this.window=a.window.$;this.document=a.document.$;this.cfg=b||{};this.init()}function m(a,b){this.window=a;this.document=b;this.events={mousemove:h(this.mousemove,this),
keydown:h(this.keydown,this),mouseup:h(this.mouseup,this)}}function h(a,b){return a.bind?a.bind(b):function(){a.apply(b,arguments)}}function g(a,b,c){a.style.left=String(b)+"px";a.style.top=String(c)+"px"}function k(a,b){var c=b.getBoundingClientRect();return{left:c.left+a.pageXOffset,top:c.top+a.pageYOffset,width:c.width,height:c.height}}var n="WebkitAppearance"in document.documentElement.style;CKEDITOR.plugins.add("dragresize",{onLoad:function(){n&&CKEDITOR.addCss("img::selection{color:rgba(0,0,0,0)}img.ckimgrsz{outline:1px dashed #000}#ckimgrsz{position:absolute;width:0;height:0;cursor:default;z-index:10001}#ckimgrsz span{display:none;position:absolute;top:0;left:0;width:0;height:0;background-size:100% 100%;opacity:.65;outline:1px dashed #000}#ckimgrsz i{position:absolute;display:block;width:5px;height:5px;background:#fff;border:1px solid #000}#ckimgrsz i.active,#ckimgrsz i:hover{background:#000}#ckimgrsz i.br,#ckimgrsz i.tl{cursor:nwse-resize}#ckimgrsz i.bm,#ckimgrsz i.tm{cursor:ns-resize}#ckimgrsz i.bl,#ckimgrsz i.tr{cursor:nesw-resize}#ckimgrsz i.lm,#ckimgrsz i.rm{cursor:ew-resize}body.dragging-br,body.dragging-br *,body.dragging-tl,body.dragging-tl *{cursor:nwse-resize!important}body.dragging-bm,body.dragging-bm *,body.dragging-tm,body.dragging-tm *{cursor:ns-resize!important}body.dragging-bl,body.dragging-bl *,body.dragging-tr,body.dragging-tr *{cursor:nesw-resize!important}body.dragging-lm,body.dragging-lm *,body.dragging-rm,body.dragging-rm *{cursor:ew-resize!important}")},
init:function(a){if(n)a.on("contentDom",function(b){p(a)})}});l.prototype={init:function(){var a=this.container=this.document.createElement("div");a.id="ckimgrsz";this.preview=this.document.createElement("span");a.appendChild(this.preview);var b=this.handles={tl:this.createHandle("tl"),tr:this.createHandle("tr"),bl:this.createHandle("bl"),br:this.createHandle("br")},c;for(c in b)a.appendChild(b[c])},createHandle:function(a){var b=this.document.createElement("i");b.classList.add(a);return b},isHandle:function(a){var b=
this.handles,c;for(c in b)if(b[c]===a)return!0;return!1},show:function(a){this.el=a;if(this.cfg.snapToSize){for(var b=this.document.getElementsByTagName("img"),c=b.length,e=Array(c),d=0;d<c;d++)e[d]=b[d];this.otherImages=e;this.otherImages.splice(this.otherImages.indexOf(a),1)}a=this.box=k(this.window,a);g(this.container,a.left,a.top);this.document.body.appendChild(this.container);this.el.classList.add("ckimgrsz");this.showHandles()},hide:function(){for(var a=this.document.getElementsByClassName("ckimgrsz"),
b=0;b<a.length;++b)a[b].classList.remove("ckimgrsz");this.hideHandles();this.container.parentNode&&this.container.parentNode.removeChild(this.container)},initDrag:function(a){if(0===a.button){var b=this,c=new m(this.window,this.document);c.onStart=function(){b.showPreview();b.isDragging=!0;b.editor.getSelection().lock()};c.onDrag=function(){b.calculateSize(this);b.updatePreview();var a=b.previewBox;b.updateHandles(a,a.left,a.top)};c.onRelease=function(){b.isDragging=!1;b.hidePreview();b.hide();b.editor.getSelection().unlock();
b.editor.fire("saveSnapshot")};c.onComplete=function(){b.resizeComplete();b.editor.fire("saveSnapshot")};c.start(a)}},updateHandles:function(a,b,c){b=b||0;c=c||0;var e=this.handles;g(e.tl,-3+b,-3+c);g(e.tr,a.width-4+b,-3+c);g(e.bl,-3+b,a.height-4+c);g(e.br,a.width-4+b,a.height-4+c)},showHandles:function(){var a=this.handles;this.updateHandles(this.box);for(var b in a)a[b].style.display="block"},hideHandles:function(){var a=this.handles,b;for(b in a)a[b].style.display="none"},showPreview:function(){this.preview.style.backgroundImage=
'url("'+this.el.src+'")';this.calculateSize();this.updatePreview();this.preview.style.display="block"},updatePreview:function(){var a=this.previewBox;g(this.preview,a.left,a.top);var b=this.preview,c=a.height;b.style.width=String(a.width)+"px";b.style.height=String(c)+"px"},hidePreview:function(){var a=k(this.window,this.preview);this.result={width:a.width,height:a.height};this.preview.style.display="none"},calculateSize:function(a){var b=this.previewBox={top:0,left:0,width:this.box.width,height:this.box.height};
if(a){var c=a.target.className;~c.indexOf("r")&&(b.width=Math.max(32,this.box.width+a.delta.x));~c.indexOf("b")&&(b.height=Math.max(32,this.box.height+a.delta.y));~c.indexOf("l")&&(b.width=Math.max(32,this.box.width-a.delta.x));~c.indexOf("t")&&(b.height=Math.max(32,this.box.height-a.delta.y));0>c.indexOf("m")&&!a.keys.shift&&(a=this.box.width/this.box.height,b.width/b.height>a?b.height=Math.round(b.width/a):b.width=Math.round(b.height*a));if(a=this.cfg.snapToSize)for(var e=this.otherImages,d=0;d<
e.length;d++){var f=k(this.window,e[d]);if(Math.abs(b.width-f.width)<=a&&Math.abs(b.height-f.height)<=a){b.width=f.width;b.height=f.height;break}}~c.indexOf("l")&&(b.left=this.box.width-b.width);~c.indexOf("t")&&(b.top=this.box.height-b.height)}},resizeComplete:function(){this.el.style.width=String(this.result.width)+"px"}};m.prototype={start:function(a){a.preventDefault();a.stopPropagation();this.target=a.target;this.attr=a.target.className;this.startPos={x:a.clientX,y:a.clientY};this.update(a);
a=this.events;this.document.addEventListener("mousemove",a.mousemove,!1);this.document.addEventListener("keydown",a.keydown,!1);this.document.addEventListener("mouseup",a.mouseup,!1);this.document.body.classList.add("dragging-"+this.attr);this.onStart&&this.onStart()},update:function(a){this.currentPos={x:a.clientX,y:a.clientY};this.delta={x:a.clientX-this.startPos.x,y:a.clientY-this.startPos.y};this.keys={shift:a.shiftKey,ctrl:a.ctrlKey,alt:a.altKey}},mousemove:function(a){this.update(a);this.onDrag&&
this.onDrag();0===a.which&&this.mouseup(a)},keydown:function(a){27===a.keyCode&&this.release()},mouseup:function(a){this.update(a);this.release();this.onComplete&&this.onComplete()},release:function(){this.document.body.classList.remove("dragging-"+this.attr);var a=this.events;this.document.removeEventListener("mousemove",a.mousemove,!1);this.document.removeEventListener("keydown",a.keydown,!1);this.document.removeEventListener("mouseup",a.mouseup,!1);this.onRelease&&this.onRelease()}}})();